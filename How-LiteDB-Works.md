### 文件格式

LiteDB是一个单文件数据库。但是数据库有很多不同类型的信息，像索引，集合，文档。要管理这些，LiteDB实现了数据库页面概念。页面是一个相同信息类型的块，并且有4096字节大小。页面是对磁盘文件的最小读/写操作。有6种页面类型：

- **头部页面（Header Page）**: 包含数据库信息，如文件版本，数据文件大小和未使用页面列表指针，数据库的第一个页面（Is the first page on database）(`PageID` = 0)。
- **集合页面**: 每个集合使用一个页面并保存所有集合信息，如名称，索引，指针和选项。所有集合在一个双向链表中互相连接。
- **索引页面**: 用于保存索引节点。LiteDB实现了跳跃列表索引，因此每一个节点都有一个键，以及一些指向其他索引节点的横向链接。
- **数据页面**: 数据页面包含数据块。每一个数据块表示一个按BSON格式序列化的文档。如果一个文档比一个页面大，数据块使用一个链接指向一个扩展页面。
- **扩展页面**: 需要多于一个页面的大文档，被序列化在多个扩展页面中。扩展页面是双向链接的，用于创建一个单数据段来存储文档。每一个扩展页面只包含一个文档或一个文档的分块。
- **空页面**: 当一个页面被排除的后会变成一个空页面。空页面会被用于下一个页面请求（用于任何类型的页面）。

每个页面有一个自己的头和内容。头用于管理普通数据结构，像PageID, PageType, Free Space。内容按每种页面类型有不同的实现。

#### 页面未使用空间

索引页面和数据页面包含一个元素集合（索引节点和数据块）。这些页面可以存储数据并保持更多可用空间。要保存在每个页面类型上的可用空间，LiteDB实现了未使用列表页面。

未使用列表是一个双向链表，按可用空间排序。当数据库需要一个页面来存储数据时，使用这个列表来搜索第一个可用页面。然后，`PagerService`修正页面顺序，并在页面上没有空间时将它从未使用列表中删除。

要创建关联的相似数据（near data related），每个集合包含一个数据未使用列表。因此，在一个数据页面中，所有数据块是同一个集合。同理适用于索引。每个索引（在每个集合上）包含你自己的未使用列表。这个解决方案需要更多磁盘空间，但读/写操作会快得多。因为数据是关联的，彼此相近的。如果你获取集合中的所有文档，数据库需要在磁盘上读的页面会更少。

### 限制

- 集合名称:
    - 模式: `A-Z`, `_-`, `0-9`
    - 最大长度为30字符
    - 不区分大小写
- 索引名称: 
    - 模式: `A-Z`, `_-`, `0-9` (`.` 用于嵌入文档)
    - 最大长度为30字符
    - 区分大小写
- BsonDocument 键名称: 
    - `A-Z`, `_-`, `0-9`
    - 区分大小写
- FileStorage FileId:
    - 模式: 与文件系统路径/文件中一样使用。
    - 区分大小写
- 集合: 所有集合名称共3000字节
- 每个集合的文档数: `UInt.MaxValue`
- 文件存储最大文件长度: 每个文件2Gb
- 索引键大小: BSON序列后512字节
- BSON 文档大小: 1.044.224 字节 (~1Mb = 256 页面)
- BSON文档嵌套深度: 20 
- 页面大小: 4096 字节
- 数据页面保留字节数: 2039 字节 (like PCT FREE)
- 索引页面保留字节数: 100 字节 (like PCT FREE)
- 数据库最大长度: 理论上，`UInt.MaxValue` * PageSize (4096) = ~ Too big!
